name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      AWS_REGION:
        description: AWS region
        required: true
        default: us-east-1
      NAME_PREFIX:
        description: Prefix name
        required: true
        default: eks
      WORKER_NODES_NUMBER:
        description: Number of worker nodes
        required: true
        default: "1"
      WORKER_NODES_TYPE:
        description: Worker nodes type
        required: true
        default: t3.medium
      PUBLIC_SSH_KEY:
        description: Public ssh key for EC2 bastion
        required: true
        default: 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGvpeb4rpaWjWK9QDdn/Nv65PM+XAT+0XIgbVEnzo45f cley@MacBook-Air-de-Christopher.local'

env:
  TF_DIR: ./terraform/aws_infra
  ANSIBLE_DIR: ./ansible

jobs:

  # -------------------- JOB 1: Terraform Validate --------------------
  validate-iac:
    name: "Job 1: Validate Infra - Terraform"
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
    steps:
      - uses: actions/checkout@v2
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.2
      - run: terraform init -backend=false
        working-directory: ${{ env.TF_DIR }}
      - run: terraform validate
        working-directory: ${{ env.TF_DIR }}

  # -------------------- JOB 2: Checkov --------------------
  security-iac:
    name: "Job 2: Security Controls Infra - Checkov"
    runs-on: ubuntu-latest
    needs: validate-iac
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
    steps:
      - uses: actions/checkout@v2
      - name: Check Terraform code with Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ${{ env.TF_DIR }}
          quiet: true
          output_format: github_failed_only
        continue-on-error: true

  # -------------------- JOB 3: Terraform Apply --------------------
  build-iac:
    name: "Job 3: Build Infra - Terraform Apply"
    runs-on: ubuntu-latest
    needs: security-iac
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
    outputs:
      cluster_name: ${{ steps.output_cluster.outputs.cluster_name }}
      cluster_endpoint: ${{ steps.output_cluster.outputs.cluster_endpoint }}
      ec2instance_dns: ${{ steps.output_cluster.outputs.ec2instance_dns }}
      ec2instance_ip: ${{ steps.output_cluster.outputs.ec2instance_ip }}
      ecr_registry_url: ${{ steps.output_cluster.outputs.ecr_registry_url }}
      vpc_id: ${{ steps.output_cluster.outputs.vpc_id }}
      region: ${{ steps.output_cluster.outputs.region }}
      ACTOR_PREFIX: ${{ steps.github_name_control.outputs.actor_prefix }}

    steps:
      - uses: actions/checkout@v2
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.2

      # ------------- Actor control ----------------
      - name: Github actor name control
        id: github_name_control
        
        run: |
          ACTOR_PREFIX=$(./scripts/github_actor_name_control.sh ${{ github.actor }})
          echo "actor_prefix=$ACTOR_PREFIX" >> $GITHUB_OUTPUT
          echo "ACTOR_PREFIX=$ACTOR_PREFIX" >> $GITHUB_ENV

      # ------------- Check or create S3 bucket ---------------
      - name: Check or create S3 Bucket for tfstate
        id: s3
        run: ./scripts/check_s3_bucket.sh ${{ github.event.inputs.NAME_PREFIX }} ${{ env.ACTOR_PREFIX }} ${{ github.event.inputs.AWS_REGION }} ./terraform/bucket_s3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}

      # ------------- Terraform Init ----------------
      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ github.event.inputs.NAME_PREFIX }}-${{ env.ACTOR_PREFIX }}-s3-tfstate" \
            -backend-config="key=infra.tfstate" \
            -backend-config="region=${{ github.event.inputs.AWS_REGION }}"
        working-directory: ${{ env.TF_DIR }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}

      # ------------- Terraform Apply ----------------
      - name: Terraform Apply
        run: |
          terraform apply \
            -var="region=${{ github.event.inputs.AWS_REGION }}" \
            -var="name_prefix=${{ github.event.inputs.NAME_PREFIX }}-${{ env.ACTOR_PREFIX }}" \
            -var="worker_nodes_desired_size=${{ github.event.inputs.WORKER_NODES_NUMBER }}" \
            -var="worker_nodes_type=${{ github.event.inputs.WORKER_NODES_TYPE }}" \
            -var="public_ssh_key=${{ github.event.inputs.PUBLIC_SSH_KEY }}" \
            -auto-approve
        working-directory: ${{ env.TF_DIR }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}

      # ------------- Extract Terraform Outputs ----------------
      - name: Extract Terraform Outputs
        id: output_cluster
        run: |
          cd ${{ env.TF_DIR }}

          # Use the Terraform binary from the setup action
          ${{ env.TERRAFORM_CLI_PATH }}/terraform-bin output -json > tf_output.json 2>&1

          # Debug: check JSON
          echo "Terraform output JSON:"
          cat tf_output.json

          # Extract individual outputs using jq
          cluster_name=$(jq -r '.cluster_name.value' tf_output.json)
          cluster_endpoint=$(jq -r '.cluster_endpoint.value' tf_output.json)
          ec2instance_dns=$(jq -r '.ec2instance_dns.value' tf_output.json)
          ec2instance_ip=$(jq -r '.ec2instance_ip.value' tf_output.json)
          ecr_registry_url=$(jq -r '.ecr_registry_url.value' tf_output.json)
          vpc_id=$(jq -r '.vpc_id.value' tf_output.json)
          region=$(jq -r '.region.value' tf_output.json || echo "${AWS_DEFAULT_REGION}")

          # debug
          echo "cluster_name=$cluster_name"
          echo "EKS endpoint=$cluster_endpoint"
          echo "ec2instance_dns=$ec2instance_dns"
          echo "ec2instance_ip=$ec2instance_ip"
          echo "ecr_registry_url=$ecr_registry_url"
          echo "vpc_id=$vpc_id"
          echo "region=$region"

          # Export for GitHub Actions
          echo "cluster_name=$cluster_name" >> $GITHUB_OUTPUT
          echo "cluster_endpoint=$cluster_endpoint" >> $GITHUB_OUTPUT
          echo "ec2instance_dns=$ec2instance_dns" >> $GITHUB_OUTPUT
          echo "ec2instance_ip=$ec2instance_ip" >> $GITHUB_OUTPUT
          echo "ecr_registry_url=$ecr_registry_url" >> $GITHUB_OUTPUT
          echo "vpc_id=$vpc_id" >> $GITHUB_OUTPUT
          echo "region=$region" >> $GITHUB_OUTPUT


  # -------------------- JOB 4b: Display Outputs --------------------
  display-infra:
    name: "Job 4b: Deployed Infra - Display Output"
    runs-on: ubuntu-latest
    needs: build-iac
    env:
      AWS_REGION: ${{ github.event.inputs.AWS_REGION }}
    steps:
      - uses: actions/checkout@v2
      - name: Display All Terraform Outputs
        run: |

          REGION="${{ needs.build-iac.outputs.region }}"
          VPC_ID="${{ needs.build-iac.outputs.vpc_id }}"
          CLUSTER_NAME="${{ needs.build-iac.outputs.cluster_name }}"
          CLUSTER_ENDPOINT="${{ needs.build-iac.outputs.cluster_endpoint }}"
          EC2_DNS="${{ needs.build-iac.outputs.ec2instance_dns }}"
          EC2_IP="${{ needs.build-iac.outputs.ec2instance_ip }}"
          ECR_URL="${{ needs.build-iac.outputs.ecr_registry_url }}"

          echo "======================="
          echo "üöÄ AWS Infra Deployed"
          echo "======================="
          echo "üîπ Region:                    $REGION"
          echo "üîπ VPC ID:                    $VPC_ID"
          echo "üîπ EKS Cluster Name:          $CLUSTER_NAME"
          echo "üîπ EKS Endpoint:              $CLUSTER_ENDPOINT"
          echo "üîπ EC2 Bastion Public DNS:    $EC2_DNS"
          echo "üîπ EC2 Bastion Public IP:     $EC2_IP"
          echo "üîπ ECR Registry URL:          $ECR_URL"
          echo "======================="

  # -------------------- JOB 4a: Ansible Security Controls --------------------
  ansible-security:
    name: "Job 4a: Automation Security Controls - Ansible"
    runs-on: ubuntu-latest
    needs: build-iac
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
    steps:
      - uses: actions/checkout@v2
      - run: pip install ansible ansible-lint
      - name: Lint Ansible
        run: ansible-lint ${{ env.ANSIBLE_DIR }}/*.yml || true

  # -------------------- JOB 5: Install Tools --------------------
  tools-deploy:
    name: "Job 5: Automation Deploy Tools - Ansible"
    runs-on: ubuntu-latest
    needs: [ansible-security, build-iac]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
      ACTOR_PREFIX: ${{ needs.build-iac.outputs.ACTOR_PREFIX }}
      EKS_CLUSTER_NAME: "${{ needs.build-iac.outputs.cluster_name }}"
    steps:
      - uses: actions/checkout@v2
      - name: Set env
        run: |
          echo "ACTOR_PREFIX='$ACTOR_PREFIX'"
          echo "Bucket S3: ${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate"
          echo "EKS_CLUSTER_NAME='$EKS_CLUSTER_NAME'"
          echo "EKS Cluster Name: $EKS_CLUSTER_NAME"
      - name: Download inventory
        run: aws s3 cp s3://${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate/ansible_inventory.ini .
        working-directory: ${{ env.ANSIBLE_DIR }}
      - name: Install Tools
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: install-tools.yml
          directory: ${{ env.ANSIBLE_DIR }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          options: |
            --inventory ansible_inventory.ini
            --extra-vars target="ec2-bastion-public"
            --extra-vars AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            --extra-vars AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            --extra-vars AWS_DEFAULT_REGION=${{ github.event.inputs.AWS_REGION }}
            --extra-vars EKS_CLUSTER_NAME=${{ needs.build-iac.outputs.cluster_name }}

  # -------------------- JOB 6b: Install ArgoCD --------------------
  install-argocd:
    name: "Job 6b: Automation Install ArgoCD - Ansible"
    runs-on: ubuntu-latest
    needs: [tools-deploy, build-iac]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
      ACTOR_PREFIX: ${{ needs.build-iac.outputs.ACTOR_PREFIX }}
      EKS_CLUSTER_NAME: "${{ needs.build-iac.outputs.cluster_name }}"
    steps:
      - uses: actions/checkout@v2
      - name: Set env
        run: |
          echo "ACTOR_PREFIX='$ACTOR_PREFIX'"
          echo "Bucket S3: ${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate"
          echo "EKS_CLUSTER_NAME='$EKS_CLUSTER_NAME'"
          echo "EKS Cluster Name: $EKS_CLUSTER_NAME"
      - name: Download inventory
        run: aws s3 cp s3://${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate/ansible_inventory.ini .
        working-directory: ${{ env.ANSIBLE_DIR }}
      - name: Install ArgoCD
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: install-argocd.yml
          directory: ${{ env.ANSIBLE_DIR }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          options: |
            --inventory ansible_inventory.ini
            --extra-vars target="ec2-bastion-public"
            --extra-vars AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            --extra-vars AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            --extra-vars AWS_DEFAULT_REGION=${{ github.event.inputs.AWS_REGION }}
            --extra-vars EKS_CLUSTER_NAME=${{ needs.build-iac.outputs.cluster_name }}
            --extra-vars github_username="chrisley75"
            --extra-vars github_token=${{ secrets.PERSONAL_GITHUB_TOKEN }}

  # -------------------- JOB 7b: Trigger Build Webapp --------------------
  trigger-webapp-build:
    name: "Job 7b: Trigger Webapp Build in Remote Repository"
    runs-on: ubuntu-latest
    needs: [install-argocd, build-iac]
    env:
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
      ECR_URL: ${{ needs.build-iac.outputs.ecr_registry_url }}
    steps:
      - uses: actions/checkout@v2

      - name: Generate Build Tag
        id: generate_tag
        run: |
          # G√©n√©ration d'un tag unique
          BUILD_TAG="build-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}"
          echo "build_tag=$BUILD_TAG" >> $GITHUB_OUTPUT
          echo "Generated build tag: $BUILD_TAG"

      - name: Trigger Webapp Build in Remote Repository
        run: |
          echo "üöÄ Triggering build in remote repository..."
          echo "üåø Branch: automation_build"
          echo "üì¶ ECR URL: $ECR_URL"
          echo "üè∑Ô∏è  Build Tag: ${{ steps.generate_tag.outputs.build_tag }}"
          echo "üéØ Full Image: $ECR_URL:${{ steps.generate_tag.outputs.build_tag }}"

          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.PERSONAL_GITHUB_TOKEN }}" \
            https://api.github.com/repos/cyberlab-cley-security/2-code-webapp-demo/actions/workflows/build_image.ym/dispatches \
            -d '{
              "ref": "automation_build",
              "inputs": {
                "image_path": "'"$ECR_URL:${{ steps.generate_tag.outputs.build_tag }}"'",
                "aws_region": "'"${{ github.event.inputs.AWS_REGION }}"'",
                "target_repository": "cyberlab-cley-security/3-deploy-webapp-demo"
              }
            }'


  # -------------------- JOB 6a: Install MongoDB --------------------
  install-mongo:
    name: "Job 6a: Automation Install MongoDB - Ansible"
    runs-on: ubuntu-latest
    needs: [tools-deploy, build-iac]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
      ACTOR_PREFIX: ${{ needs.build-iac.outputs.ACTOR_PREFIX }}
    steps:
      - uses: actions/checkout@v2
      - name: Set ACTOR_PREFIX
        run: |
          echo "ACTOR_PREFIX='$ACTOR_PREFIX'"
          echo "Bucket S3: ${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate"
      - name: Download inventory
        run: aws s3 cp s3://${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate/ansible_inventory.ini .
        working-directory: ${{ env.ANSIBLE_DIR }}
      - uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: install-mongodb6.yml
          directory: ${{ env.ANSIBLE_DIR }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          options: |
            --inventory ansible_inventory.ini
            --extra-vars target="ec2-bastion-public"
            --extra-vars AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            --extra-vars AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            --extra-vars AWS_DEFAULT_REGION=${{ github.event.inputs.AWS_REGION }}
            --extra-vars MONGO_ADMIN_USER="${{ secrets.MONGO_ADMIN_USER }}"
            --extra-vars MONGO_ADMIN_PASS="${{ secrets.MONGO_ADMIN_PASS }}"
            --extra-vars MONGO_APP_USER="${{ secrets.MONGO_APP_USER }}"
            --extra-vars MONGO_APP_PASS="${{ secrets.MONGO_APP_PASS }}"
            --extra-vars MONGO_BACKUP_USER="${{ secrets.MONGO_BACKUP_USER }}"
            --extra-vars MONGO_BACKUP_PASS="${{ secrets.MONGO_BACKUP_PASS }}"
            --extra-vars MONGO_APP_DB="${{ secrets.MONGO_APP_DB }}"

  # -------------------- JOB 7a: MongoDB Backup --------------------
  backup-mongo:
    name: "Job 7a: Automation - Configure Backup - Ansible"
    runs-on: ubuntu-latest
    needs: [install-mongo, build-iac]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
      ACTOR_PREFIX: ${{ needs.build-iac.outputs.ACTOR_PREFIX }}
    steps:
      - uses: actions/checkout@v2
      - name: Set ACTOR_PREFIX
        run: |
          echo "ACTOR_PREFIX='$ACTOR_PREFIX'"
          echo "Bucket S3: ${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate"
      - name: Download inventory
        run: aws s3 cp s3://${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate/ansible_inventory.ini .
        working-directory: ${{ env.ANSIBLE_DIR }}
      - uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: mongodb-backup.yml
          directory: ${{ env.ANSIBLE_DIR }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          options: |
            --inventory ansible_inventory.ini
            --extra-vars target="ec2-bastion-public"
            --extra-vars MONGO_BACKUP_USER="${{ secrets.MONGO_BACKUP_USER }}"
            --extra-vars MONGO_BACKUP_PASS="${{ secrets.MONGO_BACKUP_PASS }}"
            --extra-vars s3_bucket="${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate"
            --extra-vars AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            --extra-vars AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            --extra-vars AWS_DEFAULT_REGION=${{ github.event.inputs.AWS_REGION }}
