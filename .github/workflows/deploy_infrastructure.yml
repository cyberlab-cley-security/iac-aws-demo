name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      AWS_REGION:
        description: AWS region
        required: true
        default: us-east-1
      NAME_PREFIX:
        description: Prefix name
        required: true
        default: eks
      WORKER_NODES_NUMBER:
        description: Number of worker nodes
        required: true
        default: "1"
      WORKER_NODES_TYPE:
        description: Worker nodes type
        required: true
        default: t3.medium
      PUBLIC_SSH_KEY:
        description: Public ssh key for EC2 bastion
        required: true
        default: 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGvpeb4rpaWjWK9QDdn/Nv65PM+XAT+0XIgbVEnzo45f cley@MacBook-Air-de-Christopher.local'

env:
  TF_DIR: ./terraform/aws_infra
  ANSIBLE_DIR: ./ansible

# Required permissions for security scanning and job summaries
permissions:
  contents: read
  security-events: write
  actions: read

jobs:

  # -------------------- JOB 1: Terraform Validate --------------------
  validate-iac:
    name: "Job 1: Validate Infra - Terraform"
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
    steps:
      - uses: actions/checkout@v2
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.2
      - run: terraform init -backend=false
        working-directory: ${{ env.TF_DIR }}
      - run: terraform validate
        working-directory: ${{ env.TF_DIR }}

  # -------------------- JOB 2: Checkov --------------------
  security-iac:
    name: "Job 2: Security Controls Infra - Checkov"
    runs-on: ubuntu-latest
    needs: validate-iac
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
    steps:
      - uses: actions/checkout@v2
      
      # Run Checkov with SARIF output
      - name: Check Terraform code with Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ${{ env.TF_DIR }}
          quiet: false
          output_format: sarif
          output_file_path: checkov-terraform.sarif
          download_external_modules: false
        continue-on-error: true
      
      # Upload Checkov SARIF to GitHub Security tab
      - name: Upload Checkov Terraform SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-terraform.sarif
          category: checkov-terraform
        continue-on-error: true

  # -------------------- JOB 3: Terraform Apply --------------------
  build-iac:
    name: "Job 3: Build Infra - Terraform Apply"
    runs-on: ubuntu-latest
    needs: security-iac
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
    outputs:
      cluster_name: ${{ steps.output_cluster.outputs.cluster_name }}
      cluster_endpoint: ${{ steps.output_cluster.outputs.cluster_endpoint }}
      ec2instance_dns: ${{ steps.output_cluster.outputs.ec2instance_dns }}
      ec2instance_ip: ${{ steps.output_cluster.outputs.ec2instance_ip }}
      ecr_registry_url: ${{ steps.output_cluster.outputs.ecr_registry_url }}
      vpc_id: ${{ steps.output_cluster.outputs.vpc_id }}
      region: ${{ steps.output_cluster.outputs.region }}
      ACTOR_PREFIX: ${{ steps.github_name_control.outputs.actor_prefix }}

    steps:
      - uses: actions/checkout@v2
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.2

      # ------------- Actor control ----------------
      - name: Github actor name control
        id: github_name_control
        
        run: |
          ACTOR_PREFIX=$(./scripts/github_actor_name_control.sh ${{ github.actor }})
          echo "actor_prefix=$ACTOR_PREFIX" >> $GITHUB_OUTPUT
          echo "ACTOR_PREFIX=$ACTOR_PREFIX" >> $GITHUB_ENV

      # ------------- Check or create S3 bucket ---------------
      - name: Check or create S3 Bucket for tfstate
        id: s3
        run: ./scripts/check_s3_bucket.sh ${{ github.event.inputs.NAME_PREFIX }} ${{ env.ACTOR_PREFIX }} ${{ github.event.inputs.AWS_REGION }} ./terraform/bucket_s3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}

      # ------------- Terraform Init ----------------
      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ github.event.inputs.NAME_PREFIX }}-${{ env.ACTOR_PREFIX }}-s3-tfstate" \
            -backend-config="key=infra.tfstate" \
            -backend-config="region=${{ github.event.inputs.AWS_REGION }}"
        working-directory: ${{ env.TF_DIR }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}

      # ------------- Terraform Apply ----------------
      - name: Terraform Apply
        run: |
          terraform apply \
            -var="region=${{ github.event.inputs.AWS_REGION }}" \
            -var="name_prefix=${{ github.event.inputs.NAME_PREFIX }}-${{ env.ACTOR_PREFIX }}" \
            -var="worker_nodes_desired_size=${{ github.event.inputs.WORKER_NODES_NUMBER }}" \
            -var="worker_nodes_type=${{ github.event.inputs.WORKER_NODES_TYPE }}" \
            -var="public_ssh_key=${{ github.event.inputs.PUBLIC_SSH_KEY }}" \
            -auto-approve
        working-directory: ${{ env.TF_DIR }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}

      # ------------- Extract Terraform Outputs ----------------
      - name: Extract Terraform Outputs
        id: output_cluster
        run: |
          cd ${{ env.TF_DIR }}

          # Use the Terraform binary from the setup action
          ${{ env.TERRAFORM_CLI_PATH }}/terraform-bin output -json > tf_output.json 2>&1

          # Debug: check JSON
          echo "Terraform output JSON:"
          cat tf_output.json

          # Extract individual outputs using jq
          cluster_name=$(jq -r '.cluster_name.value' tf_output.json)
          cluster_endpoint=$(jq -r '.cluster_endpoint.value' tf_output.json)
          ec2instance_dns=$(jq -r '.ec2instance_dns.value' tf_output.json)
          ec2instance_ip=$(jq -r '.ec2instance_ip.value' tf_output.json)
          ecr_registry_url=$(jq -r '.ecr_registry_url.value' tf_output.json)
          vpc_id=$(jq -r '.vpc_id.value' tf_output.json)
          region=$(jq -r '.region.value' tf_output.json || echo "${AWS_DEFAULT_REGION}")

          # debug
          echo "cluster_name=$cluster_name"
          echo "EKS endpoint=$cluster_endpoint"
          echo "ec2instance_dns=$ec2instance_dns"
          echo "ec2instance_ip=$ec2instance_ip"
          echo "ecr_registry_url=$ecr_registry_url"
          echo "vpc_id=$vpc_id"
          echo "region=$region"

          # Export for GitHub Actions
          echo "cluster_name=$cluster_name" >> $GITHUB_OUTPUT
          echo "cluster_endpoint=$cluster_endpoint" >> $GITHUB_OUTPUT
          echo "ec2instance_dns=$ec2instance_dns" >> $GITHUB_OUTPUT
          echo "ec2instance_ip=$ec2instance_ip" >> $GITHUB_OUTPUT
          echo "ecr_registry_url=$ecr_registry_url" >> $GITHUB_OUTPUT
          echo "vpc_id=$vpc_id" >> $GITHUB_OUTPUT
          echo "region=$region" >> $GITHUB_OUTPUT


  # -------------------- JOB 4: Display Outputs --------------------
  display-infra:
    name: "Job 4: Deployed Infra - Display Output"
    runs-on: ubuntu-latest
    needs: build-iac
    env:
      AWS_REGION: ${{ github.event.inputs.AWS_REGION }}
    steps:
      - uses: actions/checkout@v2
      
      - name: Display All Terraform Outputs
        run: |
          REGION="${{ needs.build-iac.outputs.region }}"
          VPC_ID="${{ needs.build-iac.outputs.vpc_id }}"
          CLUSTER_NAME="${{ needs.build-iac.outputs.cluster_name }}"
          CLUSTER_ENDPOINT="${{ needs.build-iac.outputs.cluster_endpoint }}"
          EC2_DNS="${{ needs.build-iac.outputs.ec2instance_dns }}"
          EC2_IP="${{ needs.build-iac.outputs.ec2instance_ip }}"
          ECR_URL="${{ needs.build-iac.outputs.ecr_registry_url }}"

          echo "======================="
          echo "ðŸš€ AWS Infra Deployed"
          echo "======================="
          echo "ðŸ”¹ Region:                    $REGION"
          echo "ðŸ”¹ VPC ID:                    $VPC_ID"
          echo "ðŸ”¹ EKS Cluster Name:          $CLUSTER_NAME"
          echo "ðŸ”¹ EKS Endpoint:              $CLUSTER_ENDPOINT"
          echo "ðŸ”¹ EC2 Bastion Public DNS:    $EC2_DNS"
          echo "ðŸ”¹ EC2 Bastion Public IP:     $EC2_IP"
          echo "ðŸ”¹ ECR Registry URL:          $ECR_URL"
          echo "======================="

      # Create Job Summary (visible in Actions tab)
      - name: Create Deployment Summary
        run: |
          REGION="${{ needs.build-iac.outputs.region }}"
          VPC_ID="${{ needs.build-iac.outputs.vpc_id }}"
          CLUSTER_NAME="${{ needs.build-iac.outputs.cluster_name }}"
          CLUSTER_ENDPOINT="${{ needs.build-iac.outputs.cluster_endpoint }}"
          EC2_DNS="${{ needs.build-iac.outputs.ec2instance_dns }}"
          EC2_IP="${{ needs.build-iac.outputs.ec2instance_ip }}"
          ECR_URL="${{ needs.build-iac.outputs.ecr_registry_url }}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ AWS Infrastructure Deployed Successfully
          
          ### ðŸ“‹ Deployment Information
          
          | Resource | Value |
          |----------|-------|
          | **Region** | \`$REGION\` |
          | **VPC ID** | \`$VPC_ID\` |
          | **EKS Cluster Name** | \`$CLUSTER_NAME\` |
          | **EKS Endpoint** | \`$CLUSTER_ENDPOINT\` |
          | **EC2 Bastion Public DNS** | \`$EC2_DNS\` |
          | **EC2 Bastion Public IP** | \`$EC2_IP\` |
          | **ECR Registry URL** | \`$ECR_URL\` |
          
          ### ðŸ”— Quick Access Commands
          
          **Configure kubectl:**
          \`\`\`bash
          aws eks update-kubeconfig --region $REGION --name $CLUSTER_NAME
          \`\`\`
          
          **SSH to Bastion:**
          \`\`\`bash
          ssh -i ~/.ssh/id_ed25519 ec2-user@$EC2_IP
          \`\`\`
          
          **ECR Login:**
          \`\`\`bash
          aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin $ECR_URL
          \`\`\`
          
          ---
          
          :white_check_mark: **Deployment Status:** SUCCESS
          
          :calendar: **Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          EOF

      # Upload deployment info as artifact
      - name: Save Deployment Info as Artifact
        run: |
          mkdir -p deployment-info
          
          cat > deployment-info/infrastructure-details.json << EOF
          {
            "deployment_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "region": "${{ needs.build-iac.outputs.region }}",
            "vpc_id": "${{ needs.build-iac.outputs.vpc_id }}",
            "cluster_name": "${{ needs.build-iac.outputs.cluster_name }}",
            "cluster_endpoint": "${{ needs.build-iac.outputs.cluster_endpoint }}",
            "ec2_bastion_dns": "${{ needs.build-iac.outputs.ec2instance_dns }}",
            "ec2_bastion_ip": "${{ needs.build-iac.outputs.ec2instance_ip }}",
            "ecr_registry_url": "${{ needs.build-iac.outputs.ecr_registry_url }}"
          }
          EOF
          
          cat > deployment-info/README.md << EOF
          # AWS Infrastructure Deployment
          
          ## Deployment Details
          
          - **Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          - **Region:** ${{ needs.build-iac.outputs.region }}
          - **VPC ID:** ${{ needs.build-iac.outputs.vpc_id }}
          - **EKS Cluster:** ${{ needs.build-iac.outputs.cluster_name }}
          - **EKS Endpoint:** ${{ needs.build-iac.outputs.cluster_endpoint }}
          - **EC2 Bastion DNS:** ${{ needs.build-iac.outputs.ec2instance_dns }}
          - **EC2 Bastion IP:** ${{ needs.build-iac.outputs.ec2instance_ip }}
          - **ECR URL:** ${{ needs.build-iac.outputs.ecr_registry_url }}
          
          ## Quick Commands
          
          ### Configure kubectl
          \`\`\`bash
          aws eks update-kubeconfig --region ${{ needs.build-iac.outputs.region }} --name ${{ needs.build-iac.outputs.cluster_name }}
          \`\`\`
          
          ### SSH to Bastion
          \`\`\`bash
          ssh -i ~/.ssh/id_ed25519 ec2-user@${{ needs.build-iac.outputs.ec2instance_ip }}
          \`\`\`
          EOF

      - name: Upload Deployment Artifact
        uses: actions/upload-artifact@v3
        with:
          name: infrastructure-deployment-info
          path: deployment-info/
          retention-days: 90

  # -------------------- JOB 5: Ansible Security Controls --------------------
  ansible-security:
    name: "Job 5: Automation Security Controls - Ansible"
    runs-on: ubuntu-latest
    needs: build-iac
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
    steps:
      - uses: actions/checkout@v2
      
      # Install security scanning tools
      - name: Install security tools
        run: |
          pip install --upgrade pip
          pip install ansible ansible-lint
          pip install ansible-later  # Best practices verification
          pip install yamllint       # Strict YAML validation
      
      # 1. Strict YAML validation
      - name: YAML Lint
        run: |
          cat > .yamllint << EOF
          extends: default
          rules:
            line-length:
              max: 200
              level: warning
            indentation:
              spaces: 2
            truthy:
              allowed-values: ['true', 'false', 'yes', 'no']
          EOF
          yamllint -c .yamllint ${{ env.ANSIBLE_DIR }}/*.yml
        continue-on-error: true

      # 2. Ansible Lint with SARIF output
      - name: Ansible Lint (Strict Mode)
        run: |
          cat > .ansible-lint << EOF
          # Ansible-lint configuration
          
          # List of rules to check (all by default)
          # Critical security rules
          warn_list:
            - experimental
            - role-name
          
          skip_list: []
          
          # Severity level
          # Do not ignore warnings
          strict: true
          
          # Specific security rules
          enable_list:
            - no-handler
            - no-jinja-when
            - no-relative-paths
            - no-same-owner
            - yaml
          
          # Files to exclude
          exclude_paths:
            - .github/
            - test/
          EOF
          
          # Run ansible-lint with SARIF output format (if supported)
          ansible-lint -c .ansible-lint ${{ env.ANSIBLE_DIR }}/*.yml \
            -f sarif > ansible-lint.sarif || true
          
          # Also display results in console for logs
          ansible-lint -c .ansible-lint ${{ env.ANSIBLE_DIR }}/*.yml \
            --force-color --parseable || true
        continue-on-error: true

      # 3. Ansible Later - Best practices verification
      - name: Ansible Later - Best Practices Check
        run: |
          cat > .later.yml << EOF
          ---
          rules:
            # Security checks
            standards:
              - ansible_min_version
              - become_user_should_be_explicit
              - commands_should_not_be_used_in_place_of_modules
              - package_module_should_use_state
              - shell_module_should_not_be_used
              - ansible_vault_should_be_used
            
            # Minimum severity level
            min_severity: 1
          EOF
          
          ansible-later -c .later.yml ${{ env.ANSIBLE_DIR }}/*.yml || echo "âš ï¸ Ansible Later found issues"
        continue-on-error: true

      # 4. Checkov - Ansible IaC Security Scan with SARIF
      - name: Checkov - Ansible Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ${{ env.ANSIBLE_DIR }}
          framework: ansible
          output_format: sarif
          output_file_path: checkov-ansible.sarif
          quiet: false
          download_external_modules: false
        continue-on-error: true

      # 5. Upload Ansible Lint SARIF to GitHub Security
      - name: Upload Ansible Lint SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ansible-lint.sarif
          category: ansible-lint
        continue-on-error: true

      # 6. Upload Checkov Ansible SARIF to GitHub Security
      - name: Upload Checkov Ansible SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-ansible.sarif
          category: checkov-ansible
        continue-on-error: true

      # 7. Security Summary Report
      - name: Security Summary Report
        if: always()
        run: |
          echo "================================"
          echo "ðŸ›¡ï¸  ANSIBLE SECURITY SCAN SUMMARY"
          echo "================================"
          echo "âœ… YAML syntax validation: COMPLETED"
          echo "âœ… Ansible-lint checks: COMPLETED"
          echo "âœ… Ansible-later best practices: COMPLETED"
          echo "âœ… Checkov Ansible scan: COMPLETED"
          echo ""
          echo "ðŸ“Š Results uploaded to GitHub Security tab"
          echo "   â†’ Security > Code scanning alerts"
          echo "================================"

  # -------------------- JOB 6: Install Tools --------------------
  tools-deploy:
    name: "Job 6: Automation Deploy Tools - Ansible"
    runs-on: ubuntu-latest
    needs: [ansible-security, build-iac]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
      ACTOR_PREFIX: ${{ needs.build-iac.outputs.ACTOR_PREFIX }}
      EKS_CLUSTER_NAME: "${{ needs.build-iac.outputs.cluster_name }}"
    steps:
      - uses: actions/checkout@v2
      - name: Set env
        run: |
          echo "ACTOR_PREFIX='$ACTOR_PREFIX'"
          echo "Bucket S3: ${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate"
          echo "EKS_CLUSTER_NAME='$EKS_CLUSTER_NAME'"
          echo "EKS Cluster Name: $EKS_CLUSTER_NAME"
      - name: Download inventory
        run: aws s3 cp s3://${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate/ansible_inventory.ini .
        working-directory: ${{ env.ANSIBLE_DIR }}
      - name: Install Tools
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: install-tools.yml
          directory: ${{ env.ANSIBLE_DIR }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          options: |
            --inventory ansible_inventory.ini
            --extra-vars target="ec2-bastion-public"
            --extra-vars AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            --extra-vars AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            --extra-vars AWS_DEFAULT_REGION=${{ github.event.inputs.AWS_REGION }}
            --extra-vars EKS_CLUSTER_NAME=${{ needs.build-iac.outputs.cluster_name }}

  # -------------------- JOB 7: Install MongoDB --------------------
  install-mongo:
    name: "Job 7: Automation Install MongoDB - Ansible"
    runs-on: ubuntu-latest
    needs: [tools-deploy, build-iac]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
      ACTOR_PREFIX: ${{ needs.build-iac.outputs.ACTOR_PREFIX }}
    steps:
      - uses: actions/checkout@v2
      - name: Set ACTOR_PREFIX
        run: |
          echo "ACTOR_PREFIX='$ACTOR_PREFIX'"
          echo "Bucket S3: ${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate"
      - name: Download inventory
        run: aws s3 cp s3://${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate/ansible_inventory.ini .
        working-directory: ${{ env.ANSIBLE_DIR }}
      - uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: install-mongodb6.yml
          directory: ${{ env.ANSIBLE_DIR }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          options: |
            --inventory ansible_inventory.ini
            --extra-vars target="ec2-bastion-public"
            --extra-vars AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            --extra-vars AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            --extra-vars AWS_DEFAULT_REGION=${{ github.event.inputs.AWS_REGION }}
            --extra-vars MONGO_ADMIN_USER="${{ secrets.MONGO_ADMIN_USER }}"
            --extra-vars MONGO_ADMIN_PASS="${{ secrets.MONGO_ADMIN_PASS }}"
            --extra-vars MONGO_APP_USER="${{ secrets.MONGO_APP_USER }}"
            --extra-vars MONGO_APP_PASS="${{ secrets.MONGO_APP_PASS }}"
            --extra-vars MONGO_BACKUP_USER="${{ secrets.MONGO_BACKUP_USER }}"
            --extra-vars MONGO_BACKUP_PASS="${{ secrets.MONGO_BACKUP_PASS }}"
            --extra-vars MONGO_APP_DB="${{ secrets.MONGO_APP_DB }}"

  # -------------------- JOB 8: MongoDB Backup --------------------
  backup-mongo:
    name: "Job 8: Automation - Configure Backup - Ansible"
    runs-on: ubuntu-latest
    needs: [install-mongo, build-iac]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ github.event.inputs.AWS_REGION }}
      ACTOR_PREFIX: ${{ needs.build-iac.outputs.ACTOR_PREFIX }}
    steps:
      - uses: actions/checkout@v2
      - name: Set ACTOR_PREFIX
        run: |
          echo "ACTOR_PREFIX='$ACTOR_PREFIX'"
          echo "Bucket S3: ${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate"
      - name: Download inventory
        run: aws s3 cp s3://${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate/ansible_inventory.ini .
        working-directory: ${{ env.ANSIBLE_DIR }}
      - uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: mongodb-backup.yml
          directory: ${{ env.ANSIBLE_DIR }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          options: |
            --inventory ansible_inventory.ini
            --extra-vars target="ec2-bastion-public"
            --extra-vars MONGO_BACKUP_USER="${{ secrets.MONGO_BACKUP_USER }}"
            --extra-vars MONGO_BACKUP_PASS="${{ secrets.MONGO_BACKUP_PASS }}"
            --extra-vars s3_bucket="${{ github.event.inputs.NAME_PREFIX }}-$ACTOR_PREFIX-s3-tfstate"
            --extra-vars AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            --extra-vars AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            --extra-vars AWS_DEFAULT_REGION=${{ github.event.inputs.AWS_REGION }}