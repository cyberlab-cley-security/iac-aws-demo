name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      AWS_REGION:
        description: AWS region
        required: true
        default: us-east-1
      NAME_PREFIX:
        description: Prefix name
        required: true
        default: eks
      WORKER_NODES_NUMBER:
        description: Number of worker nodes
        required: true
        default: "1"
      WORKER_NODES_TYPE:
        description: Worker nodes type
        required: true
        default: t3.medium
      PUBLIC_SSH_KEY:
        description: Public ssh key for EC2 bastion
        required: true
        default: 'ssh-ed25519 AAAAC3Nza...'

env:
  TF_DIR: ./terraform/aws_infra
  ANSIBLE_DIR: ./ansible

jobs:

  # -------------------- JOB 1: Terraform Validate --------------------
  validate-iac:
    name: "Job 1: Validate Infra - Terraform"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.2

      - run: terraform init -backend=false
        working-directory: ${{ env.TF_DIR }}

      - run: terraform validate
        working-directory: ${{ env.TF_DIR }}

  # -------------------- JOB 2: Checkov --------------------
  security-iac:
    name: "Job 2: Security Controls Infra - Checkov"
    runs-on: ubuntu-latest
    needs: validate-iac
    steps:
      - uses: actions/checkout@v2
      - name: Check Terraform code with Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ${{ env.TF_DIR }}
          quiet: true
          output_format: github_failed_only
        continue-on-error: true

  # -------------------- JOB 3: Terraform Apply --------------------
  build-iac:
    name: "Job 3: Build Infra - Terraform Apply"
    runs-on: ubuntu-latest
    needs: security-iac
    outputs:
      cluster_name: ${{ steps.output_cluster.outputs.cluster_name }}
      cluster_endpoint: ${{ steps.output_cluster.outputs.cluster_endpoint }}
      cluster_security_group_id: ${{ steps.output_cluster.outputs.cluster_security_group_id }}
      ec2instance_dns: ${{ steps.output_cluster.outputs.ec2instance_dns }}
      ec2instance_ip: ${{ steps.output_cluster.outputs.ec2instance_ip }}
      ecr_registry_url: ${{ steps.output_cluster.outputs.ecr_registry_url }}
      region: ${{ steps.output_cluster.outputs.region }}
    steps:
      - uses: actions/checkout@v2
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.2

      - name: Prerequisite - Check or create S3 bucket
        run: ./scripts/check_s3_bucket.sh ${{ github.event.inputs.NAME_PREFIX }} actor ${{ github.event.inputs.AWS_REGION }}
        working-directory: ./scripts

      - name: Terraform Init
        run: terraform init \
          -backend-config="bucket=${{ github.event.inputs.NAME_PREFIX }}-actor-s3-tfstate" \
          -backend-config="key=infra.tfstate" \
          -backend-config="region=${{ github.event.inputs.AWS_REGION }}"
        working-directory: ${{ env.TF_DIR }}

      - name: Terraform Apply
        run: |
          terraform apply \
            -var="region=${{ github.event.inputs.AWS_REGION }}" \
            -var="name_prefix=${{ github.event.inputs.NAME_PREFIX }}-actor" \
            -var="worker_nodes_desired_size=${{ github.event.inputs.WORKER_NODES_NUMBER }}" \
            -var="worker_nodes_type=${{ github.event.inputs.WORKER_NODES_TYPE }}" \
            -var="public_ssh_key=${{ github.event.inputs.PUBLIC_SSH_KEY }}" \
            -auto-approve
        working-directory: ${{ env.TF_DIR }}

      - name: Extract Terraform Outputs
        id: output_cluster
        run: |
          echo "cluster_name=$(terraform output -raw cluster_name)" >> $GITHUB_OUTPUT
          echo "cluster_endpoint=$(terraform output -raw cluster_endpoint)" >> $GITHUB_OUTPUT
          echo "cluster_security_group_id=$(terraform output -raw cluster_security_group_id)" >> $GITHUB_OUTPUT
          echo "ec2instance_dns=$(terraform output -raw ec2instance_dns)" >> $GITHUB_OUTPUT
          echo "ec2instance_ip=$(terraform output -raw ec2instance_ip)" >> $GITHUB_OUTPUT
          echo "ecr_registry_url=$(terraform output -raw ecr_registry_url)" >> $GITHUB_OUTPUT
          echo "region=${{ github.event.inputs.AWS_REGION }}" >> $GITHUB_OUTPUT

      - name: Upload Ansible inventory & cluster name to S3
        run: |
          aws s3 cp ansible_inventory.ini s3://${{ github.event.inputs.NAME_PREFIX }}-actor-s3-tfstate/
          aws s3 cp cluster_name.txt s3://${{ github.event.inputs.NAME_PREFIX }}-actor-s3-tfstate/
        working-directory: ${{ env.ANSIBLE_DIR }}

  # -------------------- JOB 4: Display Outputs --------------------
  display-infra:
    name: "Job 4: Deployed Infra - Display Output"
    runs-on: ubuntu-latest
    needs: build-iac
    steps:
      - name: Display All Terraform Outputs
        run: |
          echo "======================="
          echo "üöÄ AWS Infra Deployed"
          echo "======================="
          echo ""
          echo "üîπ Region:                    ${{ needs.build-iac.outputs.region }}"
          echo "üîπ EKS Cluster Name:          ${{ needs.build-iac.outputs.cluster_name }}"
          echo "üîπ EKS Endpoint:              ${{ needs.build-iac.outputs.cluster_endpoint }}"
          echo "üîπ Cluster Security Group ID: ${{ needs.build-iac.outputs.cluster_security_group_id }}"
          echo ""
          echo "üîπ EC2 Bastion Public DNS:    ${{ needs.build-iac.outputs.ec2instance_dns }}"
          echo "üîπ EC2 Bastion Public IP:     ${{ needs.build-iac.outputs.ec2instance_ip }}"
          echo ""
          echo "üîπ ECR Registry URL:          ${{ needs.build-iac.outputs.ecr_registry_url }}"
          echo ""
          echo "======================="
          echo "‚úîÔ∏è All outputs displayed"
          echo "======================="

  # -------------------- JOB 5: Ansible Security Controls --------------------
  ansible-security:
    name: "Job 5: Application deployment - Security Controls - Ansible"
    runs-on: ubuntu-latest
    needs: build-iac
    steps:
      - uses: actions/checkout@v2
      - run: pip install ansible ansible-lint
      - name: Lint Ansible
        run: ansible-lint ${{ env.ANSIBLE_DIR }}/*.yml || true

  # -------------------- JOB 6: Install Tools --------------------
  tools-deploy:
    name: "Job 6: Deploy Tools - Ansible"
    runs-on: ubuntu-latest
    needs: ansible-security
    steps:
      - uses: actions/checkout@v2
      - name: Download inventory
        run: aws s3 cp s3://${{ github.event.inputs.NAME_PREFIX }}-actor-s3-tfstate/ansible_inventory.ini .
        working-directory: ${{ env.ANSIBLE_DIR }}
      - name: Install Tools
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: install-tools.yml
          directory: ${{ env.ANSIBLE_DIR }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          options: |
            --inventory ansible_inventory.ini
            --extra-vars target="ec2-bastion-public"

  # -------------------- JOB 7: Install MongoDB --------------------
  install-mongo:
    name: "Job 7: Install MongoDB - Ansible"
    runs-on: ubuntu-latest
    needs: tools-deploy
    steps:
      - uses: actions/checkout@v2
      - name: Download inventory
        run: aws s3 cp s3://${{ github.event.inputs.NAME_PREFIX }}-actor-s3-tfstate/ansible_inventory.ini .
        working-directory: ${{ env.ANSIBLE_DIR }}
      - uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: install-mongodb6.yml
          directory: ${{ env.ANSIBLE_DIR }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          options: |
            --inventory ansible_inventory.ini
            --extra-vars target="ec2-bastion-public"

  # -------------------- JOB 8: MongoDB Backup --------------------
  backup-mongo:
    name: "Job 8: Configure Backup - Ansible"
    runs-on: ubuntu-latest
    needs: install-mongo
    steps:
      - uses: actions/checkout@v2
      - name: Download inventory
        run: aws s3 cp s3://${{ github.event.inputs.NAME_PREFIX }}-actor-s3-tfstate/ansible_inventory.ini .
        working-directory: ${{ env.ANSIBLE_DIR }}
      - uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: mongodb-backup.yml
          directory: ${{ env.ANSIBLE_DIR }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          options: |
            --inventory ansible_inventory.ini
            --extra-vars target="ec2-bastion-public"
            --extra-vars mongo_backup_user="backup"
            --extra-vars s3_bucket="${{ github.event.inputs.NAME_PREFIX }}-actor-s3-tfstate"
