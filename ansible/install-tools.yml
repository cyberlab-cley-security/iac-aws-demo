- name: Install and configure awscli, kubectl, create ns and deploy ArgoCD
  hosts: "{{ target | default('nothing') }}"
  become: true
  vars:
    ansible_user: ubuntu
  environment:
    AWS_ACCESS_KEY_ID: "{{ AWS_ACCESS_KEY_ID }}"
    AWS_SECRET_ACCESS_KEY: "{{ AWS_SECRET_ACCESS_KEY }}"
    AWS_DEFAULT_REGION: "{{ AWS_DEFAULT_REGION }}"
    EKS_CLUSTER_NAME: "{{ EKS_CLUSTER_NAME }}"
    PATH: "/opt/ansible-venv/bin:{{ ansible_env.PATH }}"

  tasks:

    - name: Redirect apt repos to old-releases (Ubuntu 23.10 Mantic)
      ansible.builtin.replace:
        path: /etc/apt/sources.list
        regexp: 'http://.*\.archive\.ubuntu\.com/ubuntu|http://security\.ubuntu\.com/ubuntu'
        replace: 'http://old-releases.ubuntu.com/ubuntu'

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install base tools (pip, venv, jq, unzip, curl)
      ansible.builtin.apt:
        name:
          - python3-pip
          - python3-venv
          - jq
          - unzip
          - curl
        state: present

    # ---------------- AWS CLI ----------------
    - name: Install AWS CLI v2 (zip installer)
      ansible.builtin.command: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
      args:
        creates: /tmp/awscliv2.zip

    - name: Unzip AWS CLI installer
      ansible.builtin.unarchive:
        src: /tmp/awscliv2.zip
        dest: /tmp
        remote_src: yes

    - name: Install AWS CLI v2
      ansible.builtin.command: /tmp/aws/install
      args:
        creates: /usr/local/bin/aws

    # ---------------- Kubectl ----------------
    - name: Download kubectl v1.31.1
      ansible.builtin.get_url:
        url: "https://dl.k8s.io/release/v1.31.1/bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'

    # ---------------- Python Virtualenv ----------------
    - name: Create Python virtualenv for Ansible tools
      ansible.builtin.command:
        cmd: python3 -m venv /opt/ansible-venv
        creates: /opt/ansible-venv

    - name: Upgrade pip in virtualenv
      ansible.builtin.command:
        cmd: /opt/ansible-venv/bin/pip install --upgrade pip

    - name: Install pre-requisites pip packages in virtualenv
      ansible.builtin.pip:
        name:
          - openshift
          - pyyaml
          - kubernetes
        virtualenv: /opt/ansible-venv

    # ---------------- AWS & Kubeconfig ----------------
    - name: Create AWS directory
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/.aws
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Set AWS Credentials
      ansible.builtin.template:
        src: templates/credentials.j2
        dest: /home/{{ ansible_user }}/.aws/credentials
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

    - name: Set AWS Config
      ansible.builtin.template:
        src: templates/config.j2
        dest: /home/{{ ansible_user }}/.aws/config
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

    - name: Ensure .kube directory exists
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/.kube
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"

    - name: Generate kubeconfig from AWS EKS
      ansible.builtin.command: >
        aws eks update-kubeconfig
        --name {{ EKS_CLUSTER_NAME }}
        --region {{ AWS_DEFAULT_REGION }}
        --kubeconfig /home/{{ ansible_user }}/.kube/config
      args:
        creates: "/home/{{ ansible_user }}/.kube/config"
      environment:
        HOME: "/home/{{ ansible_user }}"
      become_user: "{{ ansible_user }}"

    - name: Ensure kubeconfig permissions
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/.kube/config
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"

    # ---------------- ArgoCD ----------------
    - name: Create ArgoCD namespace
      ansible.builtin.command:
        cmd: kubectl create namespace argocd
      args:
        chdir: /home/{{ ansible_user }}
      become_user: "{{ ansible_user }}"
      register: argocd_ns
      failed_when: argocd_ns.rc != 0 and "AlreadyExists" not in argocd_ns.stderr

    - name: Install ArgoCD (official install.yaml)
      ansible.builtin.command: >
        kubectl apply -n argocd
        -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
      become_user: "{{ ansible_user }}"

    - name: Wait for ArgoCD server
      ansible.builtin.command: >
        kubectl wait --namespace argocd
        --for=condition=available
        --timeout=300s
        deployment/argocd-server
      become_user: "{{ ansible_user }}"

    - name: Patch ArgoCD service to LoadBalancer
      ansible.builtin.command: >
        kubectl patch svc argocd-server -n argocd
        -p '{"spec": {"type": "LoadBalancer"}}'
      become_user: "{{ ansible_user }}"

    - name: Wait for ArgoCD LoadBalancer external hostname
      ansible.builtin.command: >
        sh -c 'kubectl get svc argocd-server -n argocd -o jsonpath="{.status.loadBalancer.ingress[0].hostname}"'
      register: argocd_lb
      retries: 20
      delay: 10
      until: argocd_lb.stdout != ""
      become_user: "{{ ansible_user }}"

    - name: Display ArgoCD URL
      ansible.builtin.debug:
        msg: |
          Argo CD is available at: https://{{ argocd_lb.stdout }}

          # Retrieve ArgoCD initial admin password:
          kubectl -n argocd get secret argocd-initial-admin-secret \
            -o jsonpath="{.data.password}" | base64 -d
